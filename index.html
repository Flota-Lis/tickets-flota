<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Lis¬∑ CEDI</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="theme-color" content="#1C2030">
  <link rel="manifest" href="data:application/json,{}">
  <link href="https://fonts.googleapis.com/css2?family=Barlow:wght@400;500;600;700;900&family=Barlow+Condensed:wght@600;700;900&display=swap" rel="stylesheet">
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    :root {
      --gold: #C8960C; --gold-light: #F5B800;
      --dark: #111318; --dark2: #1C2030; --dark3: #252A3A;
      --gray: #8A909E; --border: #2E3448;
      --red: #E53E3E; --green: #38A169; --blue: #3B82F6;
    }
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: 'Barlow', sans-serif; background: var(--dark); color: #E2E8F0; min-height: 100vh; }

    /* ‚îÄ‚îÄ OFFLINE BANNER ‚îÄ‚îÄ */
    #offline-banner {
      display: none; background: #744210; color: #FBD38D;
      text-align: center; font-size: 0.8rem; font-weight: 600;
      padding: 0.4rem; letter-spacing: 0.04em;
    }

    /* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
    #toast {
      position: fixed; bottom: 1.2rem; left: 50%; transform: translateX(-50%);
      background: var(--dark3); border: 1px solid var(--border);
      color: #E2E8F0; padding: 0.65rem 1.2rem; border-radius: 8px;
      font-size: 0.85rem; font-weight: 600; z-index: 9999;
      opacity: 0; transition: opacity 0.3s; pointer-events: none;
      white-space: nowrap; box-shadow: 0 4px 20px rgba(0,0,0,0.5);
    }
    #toast.show { opacity: 1; }
    #toast.ok  { border-color: var(--green); color: #68D391; }
    #toast.err { border-color: var(--red);   color: #FC8181; }
    #toast.inf { border-color: var(--blue);  color: #93C5FD; }

    /* ‚îÄ‚îÄ LOADING OVERLAY ‚îÄ‚îÄ */
    #loader {
      display: none; position: fixed; inset: 0;
      background: rgba(17,19,24,0.75); z-index: 998;
      align-items: center; justify-content: center;
    }
    #loader.show { display: flex; }
    .spinner {
      width: 40px; height: 40px; border: 3px solid var(--border);
      border-top-color: var(--gold-light); border-radius: 50%;
      animation: spin 0.7s linear infinite;
    }
    @keyframes spin { to { transform: rotate(360deg); } }

    /* ‚îÄ‚îÄ LIVE DOT ‚îÄ‚îÄ */
    .live-dot {
      display: inline-block; width: 8px; height: 8px;
      background: var(--green); border-radius: 50%;
      animation: pulse 1.5s ease-in-out infinite;
      margin-right: 4px; vertical-align: middle;
    }
    @keyframes pulse { 0%,100%{opacity:1;transform:scale(1)} 50%{opacity:0.5;transform:scale(0.8)} }

    /* ‚îÄ‚îÄ HEADER ‚îÄ‚îÄ */
    .app-header {
      background: var(--dark2); border-bottom: 2px solid var(--gold);
      padding: 0 1.2rem; display: flex; align-items: center;
      justify-content: space-between; height: 56px;
      position: sticky; top: 0; z-index: 100;
    }
    .app-logo { font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:1.35rem; letter-spacing:0.06em; color:var(--gold-light); }
    .app-logo span { color:#fff; }

    /* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
    .tab-bar { display:flex; background:var(--dark2); border-bottom:1px solid var(--border); }
    .tab-btn {
      font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:0.9rem;
      letter-spacing:0.1em; text-transform:uppercase; padding:0.85rem 1.6rem;
      border:none; background:transparent; color:var(--gray); cursor:pointer;
      border-bottom:3px solid transparent; white-space:nowrap; transition:all 0.2s; flex:1;
    }
    .tab-btn:hover { color:#fff; background:rgba(255,255,255,0.04); }
    .tab-btn.active { color:var(--gold-light); border-bottom-color:var(--gold-light); background:rgba(200,150,12,0.07); }

    /* ‚îÄ‚îÄ PANELS ‚îÄ‚îÄ */
    .panel { display:none; } .panel.active { display:block; }
    .main { padding:1.25rem; max-width:960px; margin:0 auto; }

    /* ‚îÄ‚îÄ SECTION TITLE ‚îÄ‚îÄ */
    .sec-title {
      font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:1.35rem;
      letter-spacing:0.05em; text-transform:uppercase; color:var(--gold-light);
      margin-bottom:1.2rem; display:flex; align-items:center; gap:0.6rem;
    }
    .sec-title::after { content:''; flex:1; height:2px; background:linear-gradient(to right,var(--border),transparent); }

    /* ‚îÄ‚îÄ FORM ‚îÄ‚îÄ */
    .card { background:var(--dark2); border:1px solid var(--border); border-radius:10px; padding:1.4rem; margin-bottom:1rem; }
    .lbl { display:block; font-size:0.72rem; font-weight:700; letter-spacing:0.1em; text-transform:uppercase; color:var(--gray); margin-bottom:0.35rem; }
    .inp {
      width:100%; background:var(--dark3); border:1px solid var(--border); border-radius:6px;
      color:#E2E8F0; padding:0.6rem 0.85rem; font-family:'Barlow',sans-serif; font-size:0.95rem;
      margin-bottom:1rem; transition:border-color 0.2s;
    }
    .inp:focus { outline:none; border-color:var(--gold); }
    .inp::placeholder { color:#4A5568; }
    .inp:disabled { opacity:0.5; cursor:not-allowed; }
    select.inp { appearance:none; cursor:pointer; }
    textarea.inp { resize:vertical; min-height:80px; }

    /* ‚îÄ‚îÄ BUTTONS ‚îÄ‚îÄ */
    .btn-gold { background:var(--gold); color:#111; font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:1rem; letter-spacing:0.08em; text-transform:uppercase; padding:0.7rem 1.5rem; border:none; border-radius:6px; cursor:pointer; width:100%; transition:all 0.2s; position:relative; overflow:hidden; }
    .btn-gold:hover { background:var(--gold-light); }
    .btn-gold:disabled { opacity:0.5; cursor:not-allowed; }
    .btn-sm { font-family:'Barlow Condensed',sans-serif; font-weight:600; font-size:0.8rem; letter-spacing:0.06em; text-transform:uppercase; padding:0.35rem 0.8rem; border-radius:5px; cursor:pointer; border:1px solid; transition:all 0.2s; }
    .btn-outline { border-color:var(--border); color:#ccc; background:var(--dark3); }
    .btn-outline:hover { border-color:var(--gold); color:var(--gold-light); }
    .btn-gre { border-color:var(--green); color:var(--green); background:transparent; }
    .btn-gre:hover { background:var(--green); color:#fff; }
    .btn-red { border-color:var(--red); color:var(--red); background:transparent; }
    .btn-red:hover { background:var(--red); color:#fff; }

    /* ‚îÄ‚îÄ PHOTO ‚îÄ‚îÄ */
    .photo-btn { background:var(--dark3); border:1px dashed var(--border); color:var(--gray); font-family:'Barlow',sans-serif; font-size:0.88rem; padding:0.65rem; border-radius:6px; width:100%; cursor:pointer; transition:all 0.2s; margin-bottom:0.75rem; }
    .photo-btn:hover { border-color:var(--gold); color:var(--gold-light); }

    /* ‚îÄ‚îÄ TABLE ‚îÄ‚îÄ */
    .tbl-wrap { overflow-x:auto; }
    table { width:100%; border-collapse:collapse; font-size:0.81rem; }
    th { background:var(--dark3); border:1px solid var(--border); padding:0.55rem 0.7rem; text-align:left; font-family:'Barlow Condensed',sans-serif; font-weight:700; letter-spacing:0.08em; text-transform:uppercase; color:var(--gray); white-space:nowrap; }
    td { border:1px solid var(--border); padding:0.5rem 0.7rem; vertical-align:middle; }
    tr:hover td { background:rgba(255,255,255,0.02); }

    .badge { padding:0.15rem 0.5rem; border-radius:4px; font-size:0.72rem; font-weight:700; letter-spacing:0.05em; border:1px solid; }
    .badge-red { background:rgba(229,62,62,0.12); color:#FC8181; border-color:rgba(229,62,62,0.3); }
    .badge-grn { background:rgba(56,161,105,0.12); color:#68D391; border-color:rgba(56,161,105,0.3); }
    .badge-gold { background:rgba(200,150,12,0.12); color:var(--gold-light); border-color:rgba(200,150,12,0.3); }

    .obs-inp { background:var(--dark3); border:1px solid var(--border); color:#E2E8F0; border-radius:4px; padding:0.3rem 0.5rem; font-size:0.8rem; width:100%; font-family:'Barlow',sans-serif; }
    .obs-inp:focus { outline:none; border-color:var(--gold); }

    /* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
    .stats-row { display:grid; grid-template-columns:repeat(3,1fr); gap:0.75rem; margin-bottom:1.2rem; }
    .stat-card { background:var(--dark2); border:1px solid var(--border); border-radius:8px; padding:0.9rem 1rem; text-align:center; }
    .stat-num { font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:1.8rem; color:var(--gold-light); }
    .stat-lbl { font-size:0.72rem; color:var(--gray); font-weight:600; letter-spacing:0.08em; text-transform:uppercase; }

    /* ‚îÄ‚îÄ MOBILE CARDS ‚îÄ‚îÄ */
    .m-card { background:var(--dark2); border:1px solid var(--border); border-radius:8px; padding:1rem; margin-bottom:0.75rem; transition:border-color 0.2s; }
    .m-card.nueva { border-color:var(--gold); animation:highlight 2s ease-out forwards; }
    @keyframes highlight { 0%{background:rgba(200,150,12,0.1)} 100%{background:var(--dark2)} }
    .m-card-top { display:flex; justify-content:space-between; align-items:flex-start; margin-bottom:0.5rem; }
    .m-card-id { font-family:'Barlow Condensed',sans-serif; font-weight:900; font-size:1.05rem; color:var(--gold-light); }
    .m-row { font-size:0.82rem; color:#A0AEC0; margin-bottom:0.25rem; }
    .m-row strong { color:#E2E8F0; }

    /* ‚îÄ‚îÄ PAGINACI√ìN ‚îÄ‚îÄ */
    .pag { display:flex; gap:0.4rem; align-items:center; justify-content:center; margin-top:1rem; flex-wrap:wrap; }
    .pag-btn { font-family:'Barlow Condensed',sans-serif; font-weight:700; font-size:0.8rem; padding:0.35rem 0.7rem; border-radius:5px; border:1px solid var(--border); background:var(--dark3); color:var(--gray); cursor:pointer; transition:all 0.2s; }
    .pag-btn:hover { border-color:var(--gold); color:var(--gold-light); }
    .pag-btn.active { background:var(--gold); color:#111; border-color:var(--gold); }
    .pag-btn:disabled { opacity:0.4; cursor:not-allowed; }
    .pag-info { font-size:0.78rem; color:var(--gray); }

    /* ‚îÄ‚îÄ LOGIN ‚îÄ‚îÄ */
    .login-wrap { max-width:360px; margin:3rem auto; }

    /* ‚îÄ‚îÄ MODAL ‚îÄ‚îÄ */
    .modal { position:fixed; inset:0; background:rgba(0,0,0,0.88); display:flex; align-items:center; justify-content:center; z-index:999; padding:1rem; }
    .modal img { max-width:100%; max-height:90vh; border-radius:8px; }

    /* ‚îÄ‚îÄ GRID ‚îÄ‚îÄ */
    .g2 { display:grid; grid-template-columns:1fr 1fr; gap:0 1rem; }
    @media(max-width:500px){ .g2{grid-template-columns:1fr;} }
    .topbar { display:flex; gap:0.5rem; flex-wrap:wrap; margin-bottom:1.2rem; align-items:center; }

    ::-webkit-scrollbar{ width:5px; height:5px; }
    ::-webkit-scrollbar-track{ background:var(--dark2); }
    ::-webkit-scrollbar-thumb{ background:var(--border); border-radius:3px; }
  </style>
</head>
<body>

<!-- OFFLINE BANNER -->
<div id="offline-banner">‚ö†Ô∏è Sin conexi√≥n ‚Äî los cambios se guardar√°n cuando vuelva la se√±al</div>

<!-- LOADER -->
<div id="loader"><div class="spinner"></div></div>

<!-- TOAST -->
<div id="toast"></div>

<!-- HEADER -->
<header class="app-header">
  <div class="app-logo">Lis <span>¬∑ CEDI</span></div>
  <div id="hdrUser" style="font-size:0.73rem;color:var(--gray);font-weight:600;letter-spacing:0.04em;display:flex;align-items:center;gap:0.4rem;"></div>
</header>

<!-- TABS -->
<nav class="tab-bar">
  <button class="tab-btn active" id="tab-conductor" onclick="switchTab('conductor')">üöõ Conductor</button>
  <button class="tab-btn" id="tab-flota"     onclick="switchTab('flota')">‚öôÔ∏è Flota</button>
  <button class="tab-btn" id="tab-seguridad" onclick="switchTab('seguridad')">üîí Seguridad</button>
</nav>

<!-- =====================================================================
     PANEL: CONDUCTOR
     ===================================================================== -->
<div class="panel active" id="panel-conductor">
  <div class="main">
    <div class="sec-title">üìã Reportar Novedad</div>
    <div class="card">
      <label class="lbl">Placa del Veh√≠culo</label>
      <input id="c-placa" class="inp" placeholder="ABC-123" maxlength="8" oninput="this.value=this.value.toUpperCase()">

      <label class="lbl">Nombre del Conductor</label>
      <input id="c-nombre" class="inp" placeholder="Nombre completo" oninput="this.value=this.value.toUpperCase()">

      <label class="lbl">Descripci√≥n de la Novedad</label>
      <textarea id="c-novedad" class="inp" placeholder="Describe la novedad detalladamente..." maxlength="500"></textarea>
      <div style="font-size:0.72rem;color:var(--gray);margin-top:-0.8rem;margin-bottom:1rem;text-align:right;" id="c-count">0 / 500</div>

      <label class="lbl">Evidencia Fotogr√°fica (opcional)</label>
      <input type="file" id="c-foto-file" accept="image/*" capture="environment" style="display:none">
      <button class="photo-btn" onclick="document.getElementById('c-foto-file').click()">üì∑ Tomar / Adjuntar Foto</button>
      <div id="c-foto-prev" style="display:none;margin-bottom:1rem;">
        <img id="c-foto-img" style="width:100%;border-radius:6px;border:1px solid var(--border);max-height:200px;object-fit:cover;margin-bottom:0.5rem;">
        <button class="btn-sm btn-red" style="width:100%;padding:0.45rem;" onclick="clearFoto('c')">Eliminar foto</button>
      </div>

      <button class="btn-gold" id="c-btn-enviar" onclick="enviarTicket()">Enviar Ticket</button>
    </div>
  </div>
</div>

<!-- =====================================================================
     PANEL: FLOTA
     ===================================================================== -->
<div class="panel" id="panel-flota">
  <div class="main">

    <!-- LOGIN -->
    <div id="flota-login" class="login-wrap">
      <div class="card">
        <div class="sec-title" style="margin-bottom:1.2rem;">‚öôÔ∏è Acceso Flota</div>
        <label class="lbl">Correo</label>
        <input id="fl-email" type="email" class="inp" placeholder="flota@bavaria.com" onkeydown="if(event.key==='Enter')loginFlota()">
        <label class="lbl">Contrase√±a</label>
        <input id="fl-pass" type="password" class="inp" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')loginFlota()">
        <button class="btn-gold" id="fl-btn-login" onclick="loginFlota()">Ingresar</button>
        <div id="fl-login-err" style="display:none;color:#FC8181;font-size:0.82rem;margin-top:0.6rem;text-align:center;"></div>
      </div>
    </div>

    <!-- PANEL FLOTA -->
    <div id="flota-panel" style="display:none;">

      <!-- STATS -->
      <div class="stats-row" id="fl-stats">
        <div class="stat-card"><div class="stat-num" id="st-total">-</div><div class="stat-lbl">Total</div></div>
        <div class="stat-card"><div class="stat-num" id="st-abiertos" style="color:#FC8181;">-</div><div class="stat-lbl">Abiertos</div></div>
        <div class="stat-card"><div class="stat-num" id="st-cerrados" style="color:#68D391;">-</div><div class="stat-lbl">Cerrados</div></div>
      </div>

      <div class="topbar">
        <div style="display:flex;align-items:center;gap:0.4rem;flex:1;">
          <span class="live-dot"></span>
          <span style="font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:1rem;letter-spacing:0.05em;color:var(--gold-light);text-transform:uppercase;">Tickets en Tiempo Real</span>
        </div>
        <button class="btn-sm btn-outline" onclick="exportarFlota()">‚Üì Excel</button>
        <button class="btn-sm btn-red" onclick="logoutFlota()">Salir</button>
      </div>

      <!-- FILTROS -->
      <div style="display:flex;gap:0.6rem;margin-bottom:1rem;flex-wrap:wrap;">
        <input id="fl-buscar" class="inp" style="margin:0;flex:1;min-width:180px;" placeholder="üîç Buscar nombre o placa..." oninput="filtrarTickets()">
        <select id="fl-filtro-estado" class="inp" style="margin:0;max-width:130px;" onchange="filtrarTickets()">
          <option value="todos">Todos</option>
          <option value="abierto">Abiertos</option>
          <option value="cerrado">Cerrados</option>
        </select>
      </div>

      <!-- TABLA PC -->
      <div class="tbl-wrap" id="fl-tbl-wrap">
        <table>
          <thead>
            <tr>
              <th>Creaci√≥n</th><th>Cierre</th><th>Tiempo</th>
              <th>Placa</th><th>Conductor</th><th>Novedad</th>
              <th>Foto</th><th>Observaciones</th><th>Estado</th><th>Acciones</th>
            </tr>
          </thead>
          <tbody id="fl-tbody"></tbody>
        </table>
      </div>

      <!-- CARDS MOBILE -->
      <div id="fl-cards"></div>

      <!-- PAGINACI√ìN -->
      <div class="pag" id="fl-pag"></div>
    </div>
  </div>
</div>

<!-- =====================================================================
     PANEL: SEGURIDAD
     ===================================================================== -->
<div class="panel" id="panel-seguridad">
  <div class="main">

    <!-- LOGIN -->
    <div id="seg-login" class="login-wrap">
      <div class="card">
        <div class="sec-title" style="margin-bottom:1.2rem;">üîí Acceso Seguridad</div>
        <label class="lbl">Correo</label>
        <input id="sg-email" type="email" class="inp" placeholder="seguridad@bavaria.com" onkeydown="if(event.key==='Enter')loginSeguridad()">
        <label class="lbl">Contrase√±a</label>
        <input id="sg-pass" type="password" class="inp" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" onkeydown="if(event.key==='Enter')loginSeguridad()">
        <button class="btn-gold" id="sg-btn-login" onclick="loginSeguridad()">Ingresar</button>
        <div id="sg-login-err" style="display:none;color:#FC8181;font-size:0.82rem;margin-top:0.6rem;text-align:center;"></div>
      </div>
    </div>

    <!-- PANEL SEGURIDAD -->
    <div id="seg-panel" style="display:none;">

      <div class="topbar">
        <div style="display:flex;align-items:center;gap:0.4rem;flex:1;">
          <span class="live-dot"></span>
          <span style="font-family:'Barlow Condensed',sans-serif;font-weight:700;font-size:1rem;letter-spacing:0.05em;color:var(--gold-light);text-transform:uppercase;">Panel Seguridad</span>
        </div>
        <button class="btn-sm btn-outline" onclick="exportarSeguridad()">‚Üì Excel EPP</button>
        <button class="btn-sm btn-red" onclick="logoutSeguridad()">Salir</button>
      </div>

      <!-- SUB-TABS OL / UC -->
      <div style="display:flex;gap:0.5rem;margin-bottom:1.2rem;">
        <button id="sub-ol" onclick="setSubTab('ol')"
          style="flex:1;padding:0.65rem;border:1px solid var(--gold);color:var(--gold-light);background:rgba(200,150,12,0.08);border-radius:6px;font-family:'Barlow Condensed',sans-serif;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;transition:all 0.2s;">
          üì¶ OL ‚Äî Operador Log√≠stico
        </button>
        <button id="sub-uc" onclick="setSubTab('uc')"
          style="flex:1;padding:0.65rem;border:1px solid var(--border);color:var(--gray);background:transparent;border-radius:6px;font-family:'Barlow Condensed',sans-serif;font-weight:700;letter-spacing:0.08em;text-transform:uppercase;cursor:pointer;transition:all 0.2s;">
          üè≠ UC
        </button>
      </div>

      <!-- STATS EPP -->
      <div class="stats-row" style="grid-template-columns:1fr 1fr;" id="ep-stats">
        <div class="stat-card"><div class="stat-num" id="st-ep-total">-</div><div class="stat-lbl">Registros √Årea</div></div>
        <div class="stat-card"><div class="stat-num" id="st-ep-hoy" style="color:#68D391;">-</div><div class="stat-lbl">Hoy</div></div>
      </div>

      <!-- FORMULARIO EPP -->
      <div class="card">
        <div id="seg-form-title" class="sec-title" style="margin-bottom:1rem;font-size:1rem;">üì¶ Registrar EPP ¬∑ OL</div>

        <div class="g2">
          <div>
            <label class="lbl">Nombre del Colaborador</label>
            <input id="ep-nombre" class="inp" placeholder="Nombre completo" oninput="this.value=this.value.toUpperCase()">
          </div>
          <div>
            <label class="lbl">Fecha de Entrega</label>
            <input id="ep-fecha" class="inp" type="date" readonly style="cursor:default;opacity:0.8;">
          </div>
        </div>

        <label class="lbl">Cargo del Colaborador</label>
        <select id="ep-cargo" class="inp">
          <option value="">‚Äî Selecciona cargo ‚Äî</option>
        </select>

        <label class="lbl">EPP Entregado</label>
        <select id="ep-epp" class="inp">
          <option value="">‚Äî Selecciona el EPP ‚Äî</option>
          <option>Casco de seguridad</option>
          <option>Chaleco reflectivo</option>
          <option>Guantes de protecci√≥n</option>
          <option>Botas con puntera de acero</option>
          <option>Gafas de seguridad</option>
        </select>

        <label class="lbl">Responsable de Entrega</label>
        <select id="ep-responsable" class="inp">
          <option value="">‚Äî Selecciona responsable ‚Äî</option>
        </select>

        <label class="lbl">Evidencia Fotogr√°fica (opcional)</label>
        <input type="file" id="ep-foto-file" accept="image/*" capture="environment" style="display:none">
        <button class="photo-btn" onclick="document.getElementById('ep-foto-file').click()">üì∑ Tomar / Adjuntar Foto</button>
        <div id="ep-foto-prev" style="display:none;margin-bottom:1rem;">
          <img id="ep-foto-img" style="width:100%;border-radius:6px;border:1px solid var(--border);max-height:200px;object-fit:cover;margin-bottom:0.5rem;">
          <button class="btn-sm btn-red" style="width:100%;padding:0.45rem;" onclick="clearFoto('ep')">Eliminar foto</button>
        </div>

        <button class="btn-gold" id="ep-btn-enviar" onclick="enviarEPP()">Registrar Entrega EPP</button>
      </div>

      <!-- BUSCADOR + TABLA EPP -->
      <div class="sec-title" style="font-size:1rem;margin-top:0.5rem;">
        <span class="live-dot"></span> Historial de Registros
      </div>

      <div style="margin-bottom:1rem;">
        <input id="ep-buscar" class="inp" style="margin:0;" placeholder="üîç Buscar por nombre del colaborador..." oninput="filtrarEPP()">
      </div>

      <div class="tbl-wrap" id="ep-tbl-wrap">
        <table>
          <thead>
            <tr>
              <th>Fecha</th><th>√Årea</th><th>Colaborador</th>
              <th>Cargo</th><th>EPP</th><th>Responsable</th><th>Foto</th><th>Eliminar</th>
            </tr>
          </thead>
          <tbody id="ep-tbody"></tbody>
        </table>
      </div>
      <div id="ep-cards"></div>
      <div class="pag" id="ep-pag"></div>
    </div>
  </div>
</div>

<!-- FOOTER -->
<footer style="text-align:center;padding:1.5rem;color:var(--gray);font-size:0.73rem;letter-spacing:0.05em;border-top:1px solid var(--border);margin-top:2rem;">
  ¬© 2026 <strong style="color:var(--gold-light);">Anderson Alzate</strong> ¬∑ Todos los derechos reservados
</footer>

<script type="module">
import { initializeApp }    from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
import {
  getFirestore, collection, addDoc, getDocs, getDoc,
  updateDoc, deleteDoc, doc, Timestamp,
  query, orderBy, onSnapshot, where
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
import {
  getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

/* ‚îÄ‚îÄ CONFIG ‚îÄ‚îÄ */
const app = initializeApp({
  apiKey: "AIzaSyDXqaQBxsxpBEfyrOGFGG9EwcDUhH8Xec0",
  authDomain: "tickets-1a224.firebaseapp.com",
  projectId: "tickets-1a224"
});
const db   = getFirestore(app);
const auth = getAuth(app);

const colTickets = collection(db, "tickets");
const colEPP     = collection(db, "epp_registros");
const colUsuarios = collection(db, "usuarios"); // roles

/* ‚îÄ‚îÄ CONFIGURACI√ìN ‚îÄ‚îÄ */
const POR_PAGINA = 15;

const responsables = {
  ol: ['Responsable OL 1','Responsable OL 2','Responsable OL 3','Responsable OL 4','Responsable OL 5'],
  uc: ['Responsable UC 1','Responsable UC 2','Responsable UC 3']
};
const cargos = {
  ol: ['Supervisor','Auxiliar Log√≠stico','OPM'],
  uc: ['Coordinador','RR','Conductor','Auxiliar de Reparto']
};

/* ‚îÄ‚îÄ ESTADO LOCAL ‚îÄ‚îÄ */
let todosTickets    = [];
let todosEPP        = [];
let subTab          = 'ol';
let paginaTickets   = 1;
let paginaEPP       = 1;
let unsubTickets    = null;
let unsubEPP        = null;
const fotoData      = { c: null, ep: null };

/* ‚îÄ‚îÄ OFFLINE DETECTOR ‚îÄ‚îÄ */
window.addEventListener('online',  () => { document.getElementById('offline-banner').style.display = 'none';  toast('Conexi√≥n restaurada ‚úì', 'ok'); });
window.addEventListener('offline', () => { document.getElementById('offline-banner').style.display = 'block'; toast('Sin conexi√≥n a internet', 'err'); });

/* ‚îÄ‚îÄ TOAST ‚îÄ‚îÄ */
let toastTimer;
function toast(msg, tipo = 'ok') {
  const el = document.getElementById('toast');
  el.textContent = msg;
  el.className = `show ${tipo}`;
  clearTimeout(toastTimer);
  toastTimer = setTimeout(() => { el.className = ''; }, 3000);
}

/* ‚îÄ‚îÄ LOADER ‚îÄ‚îÄ */
function showLoader()  { document.getElementById('loader').classList.add('show'); }
function hideLoader()  { document.getElementById('loader').classList.remove('show'); }

/* ‚îÄ‚îÄ TABS ‚îÄ‚îÄ */
window.switchTab = (tab) => {
  document.querySelectorAll('.panel').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
  document.getElementById('panel-' + tab).classList.add('active');
  document.getElementById('tab-' + tab).classList.add('active');
};

/* ‚îÄ‚îÄ SUB-TABS SEGURIDAD ‚îÄ‚îÄ */
window.setSubTab = (area) => {
  subTab = area;
  const isOL = area === 'ol';
  ['ol','uc'].forEach(a => {
    const b = document.getElementById('sub-' + a);
    const active = a === area;
    b.style.borderColor = active ? 'var(--gold)' : 'var(--border)';
    b.style.color       = active ? 'var(--gold-light)' : 'var(--gray)';
    b.style.background  = active ? 'rgba(200,150,12,0.08)' : 'transparent';
  });
  document.getElementById('seg-form-title').textContent =
    isOL ? 'üì¶ Registrar EPP ¬∑ OL' : 'üè≠ Registrar EPP ¬∑ UC';

  const selR = document.getElementById('ep-responsable');
  selR.innerHTML = '<option value="">‚Äî Selecciona responsable ‚Äî</option>';
  responsables[area].forEach(r => { const o = document.createElement('option'); o.textContent = r; selR.appendChild(o); });

  const selC = document.getElementById('ep-cargo');
  selC.innerHTML = '<option value="">‚Äî Selecciona cargo ‚Äî</option>';
  cargos[area].forEach(c => { const o = document.createElement('option'); o.textContent = c; selC.appendChild(o); });

  paginaEPP = 1;
  document.getElementById('ep-buscar').value = '';
  renderEPP(todosEPP.filter(r => r.area.toLowerCase() === subTab));
};

/* ‚îÄ‚îÄ FECHA ‚îÄ‚îÄ */
function fechaHoy() { return new Date().toISOString().split('T')[0]; }
document.getElementById('ep-fecha').value = fechaHoy();

// Init OL por defecto
const selRInit = document.getElementById('ep-responsable');
responsables['ol'].forEach(r => { const o = document.createElement('option'); o.textContent = r; selRInit.appendChild(o); });
const selCInit = document.getElementById('ep-cargo');
cargos['ol'].forEach(c => { const o = document.createElement('option'); o.textContent = c; selCInit.appendChild(o); });

/* ‚îÄ‚îÄ CONTADOR TEXTAREA ‚îÄ‚îÄ */
document.getElementById('c-novedad').addEventListener('input', function() {
  document.getElementById('c-count').textContent = `${this.value.length} / 500`;
});

/* ‚îÄ‚îÄ FOTOS ‚îÄ‚îÄ */
['c','ep'].forEach(p => {
  document.getElementById(p + '-foto-file').addEventListener('change', e => {
    const file = e.target.files[0];
    if (!file) return;
    // Validar tama√±o antes de comprimir
    if (file.size > 10 * 1024 * 1024) { toast('Foto muy grande (m√°x 10MB)', 'err'); return; }
    const reader = new FileReader();
    reader.onload = ev => comprimirImagen(ev.target.result, comp => {
      fotoData[p] = comp;
      document.getElementById(p + '-foto-img').src = comp;
      document.getElementById(p + '-foto-prev').style.display = 'block';
      // Estimar tama√±o comprimido
      const kb = Math.round((comp.length * 3/4) / 1024);
      toast(`Foto lista (~${kb}KB)`, 'ok');
    });
    reader.readAsDataURL(file);
  });
});

window.clearFoto = (p) => {
  fotoData[p] = null;
  document.getElementById(p + '-foto-file').value = '';
  document.getElementById(p + '-foto-prev').style.display = 'none';
};

function comprimirImagen(base64, cb) {
  const img = new Image();
  img.onload = () => {
    const canvas = document.createElement('canvas');
    let [w, h] = [img.width, img.height];
    // M√°x 480px, calidad 35% ‚Üí ~50-70KB
    const max = 480;
    if (w > max || h > max) {
      if (w > h) { h = Math.round(h * max/w); w = max; }
      else { w = Math.round(w * max/h); h = max; }
    }
    canvas.width = w; canvas.height = h;
    canvas.getContext('2d').drawImage(img, 0, 0, w, h);
    const result = canvas.toDataURL('image/jpeg', 0.35);
    // Advertir si sigue siendo grande (>700KB en base64 ‚âà ~500KB real)
    if (result.length > 700000) {
      toast('‚ö†Ô∏è Foto a√∫n grande, puede fallar', 'inf');
    }
    cb(result);
  };
  img.src = base64;
}

/* ‚îÄ‚îÄ AUTH FLOTA ‚îÄ‚îÄ */
window.loginFlota = async () => {
  const email = document.getElementById('fl-email').value.trim();
  const pass  = document.getElementById('fl-pass').value;
  const errEl = document.getElementById('fl-login-err');
  const btn   = document.getElementById('fl-btn-login');
  errEl.style.display = 'none';
  if (!email || !pass) { errEl.textContent = 'Ingresa correo y contrase√±a'; errEl.style.display = 'block'; return; }

  btn.disabled = true; btn.textContent = 'Verificando...'; showLoader();
  try {
    const cred = await signInWithEmailAndPassword(auth, email, pass);
    // Verificar rol en Firestore
    const rolDoc = await getDoc(doc(db, 'usuarios', cred.user.uid));
    const rol = rolDoc.exists() ? rolDoc.data().rol : 'flota'; // default flota si no tiene doc
    if (rol !== 'flota' && rol !== 'admin') {
      await signOut(auth);
      errEl.textContent = 'No tienes acceso a este panel';
      errEl.style.display = 'block';
      return;
    }
    mostrarPanelFlota(cred.user.email);
  } catch(err) {
    const msgs = {
      'auth/user-not-found': 'Usuario no encontrado',
      'auth/wrong-password': 'Contrase√±a incorrecta',
      'auth/invalid-email': 'Correo inv√°lido',
      'auth/too-many-requests': 'Demasiados intentos, espera un momento',
      'auth/invalid-credential': 'Credenciales incorrectas'
    };
    errEl.textContent = msgs[err.code] || 'Error al iniciar sesi√≥n';
    errEl.style.display = 'block';
  } finally {
    btn.disabled = false; btn.textContent = 'Ingresar'; hideLoader();
  }
};

window.logoutFlota = async () => {
  if (unsubTickets) { unsubTickets(); unsubTickets = null; }
  await signOut(auth);
  document.getElementById('flota-login').style.display = 'block';
  document.getElementById('flota-panel').style.display = 'none';
  document.getElementById('fl-email').value = '';
  document.getElementById('fl-pass').value  = '';
  document.getElementById('hdrUser').innerHTML = '';
  switchTab('conductor');
};

function mostrarPanelFlota(email) {
  document.getElementById('flota-login').style.display = 'none';
  document.getElementById('flota-panel').style.display = 'block';
  document.getElementById('hdrUser').innerHTML = `<span style="color:var(--green);">‚óè</span> ${email}`;
  suscribirTickets();
}

/* ‚îÄ‚îÄ AUTH SEGURIDAD ‚îÄ‚îÄ */
window.loginSeguridad = async () => {
  const email = document.getElementById('sg-email').value.trim();
  const pass  = document.getElementById('sg-pass').value;
  const errEl = document.getElementById('sg-login-err');
  const btn   = document.getElementById('sg-btn-login');
  errEl.style.display = 'none';
  if (!email || !pass) { errEl.textContent = 'Ingresa correo y contrase√±a'; errEl.style.display = 'block'; return; }

  btn.disabled = true; btn.textContent = 'Verificando...'; showLoader();
  try {
    const cred = await signInWithEmailAndPassword(auth, email, pass);
    const rolDoc = await getDoc(doc(db, 'usuarios', cred.user.uid));
    const rol = rolDoc.exists() ? rolDoc.data().rol : 'seguridad';
    if (rol !== 'seguridad' && rol !== 'admin') {
      await signOut(auth);
      errEl.textContent = 'No tienes acceso a este panel';
      errEl.style.display = 'block';
      return;
    }
    mostrarPanelSeguridad(cred.user.email);
  } catch(err) {
    const msgs = {
      'auth/user-not-found': 'Usuario no encontrado',
      'auth/wrong-password': 'Contrase√±a incorrecta',
      'auth/invalid-email': 'Correo inv√°lido',
      'auth/too-many-requests': 'Demasiados intentos, espera un momento',
      'auth/invalid-credential': 'Credenciales incorrectas'
    };
    errEl.textContent = msgs[err.code] || 'Error al iniciar sesi√≥n';
    errEl.style.display = 'block';
  } finally {
    btn.disabled = false; btn.textContent = 'Ingresar'; hideLoader();
  }
};

window.logoutSeguridad = async () => {
  if (unsubEPP) { unsubEPP(); unsubEPP = null; }
  await signOut(auth);
  document.getElementById('seg-login').style.display = 'block';
  document.getElementById('seg-panel').style.display = 'none';
  document.getElementById('sg-email').value = '';
  document.getElementById('sg-pass').value  = '';
  document.getElementById('hdrUser').innerHTML = '';
  switchTab('conductor');
};

function mostrarPanelSeguridad(email) {
  document.getElementById('seg-login').style.display = 'none';
  document.getElementById('seg-panel').style.display = 'block';
  document.getElementById('hdrUser').innerHTML = `<span style="color:var(--green);">‚óè</span> ${email}`;
  setSubTab('ol');
  suscribirEPP();
}

/* ‚îÄ‚îÄ TIEMPO REAL ‚Äî TICKETS ‚îÄ‚îÄ */
function suscribirTickets() {
  if (unsubTickets) unsubTickets();
  const q = query(colTickets, orderBy('fechaCreacion', 'desc'));
  unsubTickets = onSnapshot(q, (snap) => {
    const prevCount = todosTickets.length;
    todosTickets = [];
    snap.forEach(d => todosTickets.push({ id: d.id, ...d.data() }));
    // Notificar si llega uno nuevo
    if (prevCount > 0 && todosTickets.length > prevCount) {
      toast('üîî Nuevo ticket recibido', 'inf');
    }
    actualizarStatsTickets();
    filtrarTickets();
  }, (err) => {
    toast('Error cargando tickets: ' + err.message, 'err');
  });
}

/* ‚îÄ‚îÄ TIEMPO REAL ‚Äî EPP ‚îÄ‚îÄ */
function suscribirEPP() {
  if (unsubEPP) unsubEPP();
  const q = query(colEPP, orderBy('fechaCreacion', 'desc'));
  unsubEPP = onSnapshot(q, (snap) => {
    todosEPP = [];
    snap.forEach(d => todosEPP.push({ id: d.id, ...d.data() }));
    actualizarStatsEPP();
    filtrarEPP();
  }, (err) => {
    toast('Error cargando EPP: ' + err.message, 'err');
  });
}

/* ‚îÄ‚îÄ STATS ‚îÄ‚îÄ */
function actualizarStatsTickets() {
  const abiertos = todosTickets.filter(t => t.estado === 'abierto').length;
  document.getElementById('st-total').textContent    = todosTickets.length;
  document.getElementById('st-abiertos').textContent = abiertos;
  document.getElementById('st-cerrados').textContent = todosTickets.length - abiertos;
}

function actualizarStatsEPP() {
  const deArea = todosEPP.filter(r => r.area.toLowerCase() === subTab);
  const hoy    = deArea.filter(r => r.fecha === fechaHoy()).length;
  document.getElementById('st-ep-total').textContent = deArea.length;
  document.getElementById('st-ep-hoy').textContent   = hoy;
}

/* ‚îÄ‚îÄ HELPERS FECHA ‚îÄ‚îÄ */
function parseFecha(f) {
  if (!f) return null;
  if (typeof f.toDate === 'function') return f.toDate();
  if (f instanceof Date) return f;
  const d = new Date(f); return isNaN(d) ? null : d;
}
function fmt(f) { const d = parseFecha(f); return d ? d.toLocaleString('es-CO') : '-'; }
function tiempoTranscurrido(a, b) {
  const da = parseFecha(a), db = parseFecha(b);
  if (!da || !db) return '-';
  const diff = db - da;
  return `${Math.floor(diff/3600000)}h ${Math.floor((diff%3600000)/60000)}m`;
}

/* ‚îÄ‚îÄ FILTROS ‚îÄ‚îÄ */
window.filtrarTickets = () => {
  const q      = (document.getElementById('fl-buscar')?.value || '').trim().toLowerCase();
  const estado = document.getElementById('fl-filtro-estado')?.value || 'todos';
  paginaTickets = 1;
  let lista = todosTickets;
  if (estado !== 'todos') lista = lista.filter(t => t.estado === estado);
  if (q) lista = lista.filter(t => (t.nombre||'').toLowerCase().includes(q) || (t.placa||'').toLowerCase().includes(q));
  renderTickets(lista);
};

window.filtrarEPP = () => {
  const q = (document.getElementById('ep-buscar')?.value || '').trim().toLowerCase();
  paginaEPP = 1;
  let lista = todosEPP.filter(r => r.area.toLowerCase() === subTab);
  if (q) lista = lista.filter(r => (r.nombre||'').toLowerCase().includes(q));
  renderEPP(lista);
};

/* ‚îÄ‚îÄ PAGINACI√ìN ‚îÄ‚îÄ */
function paginar(lista, pagina) {
  const total  = Math.ceil(lista.length / POR_PAGINA);
  const inicio = (pagina - 1) * POR_PAGINA;
  return { pagina: lista.slice(inicio, inicio + POR_PAGINA), total, inicio };
}

function renderPaginacion(contenedorId, total, actual, onCambio) {
  const el = document.getElementById(contenedorId);
  if (total <= 1) { el.innerHTML = ''; return; }
  let html = `<button class="pag-btn" ${actual===1?'disabled':''} onclick="${onCambio}(${actual-1})">‚Äπ</button>`;
  for (let i = 1; i <= total; i++) {
    if (total > 7 && Math.abs(i - actual) > 2 && i !== 1 && i !== total) {
      if (i === 2 || i === total-1) html += `<span class="pag-info">‚Ä¶</span>`;
      continue;
    }
    html += `<button class="pag-btn ${i===actual?'active':''}" onclick="${onCambio}(${i})">${i}</button>`;
  }
  html += `<button class="pag-btn" ${actual===total?'disabled':''} onclick="${onCambio}(${actual+1})">‚Ä∫</button>`;
  html += `<span class="pag-info" style="margin-left:0.3rem;">${actual} / ${total}</span>`;
  el.innerHTML = html;
}

window.cambiarPagTickets = (p) => { paginaTickets = p; filtrarTickets(); window.scrollTo({top:200,behavior:'smooth'}); };
window.cambiarPagEPP     = (p) => { paginaEPP = p;     filtrarEPP();     window.scrollTo({top:200,behavior:'smooth'}); };

/* ‚îÄ‚îÄ RENDER TICKETS ‚îÄ‚îÄ */
function renderTickets(listaFiltrada) {
  const isMobile = window.innerWidth < 768;
  document.getElementById('fl-tbl-wrap').style.display = isMobile ? 'none' : 'block';
  const tbody = document.getElementById('fl-tbody');
  const cards = document.getElementById('fl-cards');
  tbody.innerHTML = ''; cards.innerHTML = '';

  if (listaFiltrada.length === 0) {
    cards.innerHTML = `<div style="text-align:center;color:var(--gray);padding:2.5rem;background:var(--dark2);border-radius:8px;border:1px solid var(--border);">Sin resultados</div>`;
    document.getElementById('fl-pag').innerHTML = '';
    return;
  }

  const { pagina, total } = paginar(listaFiltrada, paginaTickets);
  renderPaginacion('fl-pag', total, paginaTickets, 'cambiarPagTickets');

  pagina.forEach(t => {
    const badge = t.estado === 'abierto'
      ? `<span class="badge badge-red">ABIERTO</span>`
      : `<span class="badge badge-grn">CERRADO</span>`;

    tbody.innerHTML += `
      <tr>
        <td style="white-space:nowrap;">${fmt(t.fechaCreacion)}</td>
        <td style="white-space:nowrap;">${fmt(t.fechaCierre)}</td>
        <td>${tiempoTranscurrido(t.fechaCreacion, t.fechaCierre)}</td>
        <td style="font-weight:700;color:var(--gold-light);">${t.placa}</td>
        <td>${t.nombre}</td>
        <td style="max-width:200px;">${t.novedad}</td>
        <td>${t.foto ? `<button onclick="verFoto('${t.id}','ticket')" style="background:none;border:none;color:var(--gold-light);cursor:pointer;font-size:0.85rem;">üì∑ Ver</button>` : '-'}</td>
        <td><input class="obs-inp" value="${(t.observaciones||'').replace(/"/g,'&quot;')}" onchange="guardarObs('${t.id}',this.value)" placeholder="Agregar..."></td>
        <td>${badge}</td>
        <td style="white-space:nowrap;">
          <div style="display:flex;flex-direction:column;gap:0.3rem;">
            ${t.estado==='abierto' ? `<button onclick="cerrarTicket('${t.id}')" class="btn-sm btn-gre" style="font-size:0.75rem;">‚úî Cerrar</button>` : ''}
            <button onclick="eliminarTicket('${t.id}')" class="btn-sm btn-red" style="font-size:0.75rem;">üóë Borrar</button>
          </div>
        </td>
      </tr>`;

    cards.innerHTML += `
      <div class="m-card">
        <div class="m-card-top">
          <span class="m-card-id">${t.placa}</span>${badge}
        </div>
        <div class="m-row"><strong>Conductor:</strong> ${t.nombre}</div>
        <div class="m-row"><strong>Novedad:</strong> ${t.novedad}</div>
        <div class="m-row"><strong>Creaci√≥n:</strong> ${fmt(t.fechaCreacion)}</div>
        <div class="m-row"><strong>Cierre:</strong> ${fmt(t.fechaCierre)}</div>
        <div class="m-row" style="margin-bottom:0.6rem;"><strong>Tiempo:</strong> ${tiempoTranscurrido(t.fechaCreacion, t.fechaCierre)}</div>
        ${t.foto ? `<div style="margin-bottom:0.6rem;"><button onclick="verFoto('${t.id}','ticket')" style="background:none;border:1px solid var(--border);color:var(--gold-light);cursor:pointer;font-size:0.82rem;padding:0.3rem 0.7rem;border-radius:5px;width:100%;">üì∑ Ver foto</button></div>` : ''}
        <textarea class="obs-inp" style="min-height:55px;margin-bottom:0.6rem;" placeholder="Observaciones..." onchange="guardarObs('${t.id}',this.value)">${t.observaciones||''}</textarea>
        <div style="display:flex;gap:0.5rem;">
          ${t.estado==='abierto' ? `<button onclick="cerrarTicket('${t.id}')" class="btn-sm btn-gre" style="flex:1;padding:0.5rem;">‚úî Cerrar</button>` : ''}
          <button onclick="eliminarTicket('${t.id}')" class="btn-sm btn-red" style="padding:0.5rem 0.9rem;">üóë</button>
        </div>
      </div>`;
  });
}

/* ‚îÄ‚îÄ RENDER EPP ‚îÄ‚îÄ */
function renderEPP(listaFiltrada) {
  actualizarStatsEPP();
  const isMobile = window.innerWidth < 768;
  document.getElementById('ep-tbl-wrap').style.display = isMobile ? 'none' : 'block';
  const tbody = document.getElementById('ep-tbody');
  const cards = document.getElementById('ep-cards');
  tbody.innerHTML = ''; cards.innerHTML = '';

  if (listaFiltrada.length === 0) {
    cards.innerHTML = `<div style="text-align:center;color:var(--gray);padding:2.5rem;background:var(--dark2);border-radius:8px;border:1px solid var(--border);">Sin resultados</div>`;
    document.getElementById('ep-pag').innerHTML = '';
    return;
  }

  const { pagina, total } = paginar(listaFiltrada, paginaEPP);
  renderPaginacion('ep-pag', total, paginaEPP, 'cambiarPagEPP');

  pagina.forEach(r => {
    tbody.innerHTML += `
      <tr>
        <td>${r.fecha||'-'}</td>
        <td><span class="badge badge-gold">${r.area}</span></td>
        <td style="font-weight:600;">${r.nombre}</td>
        <td>${r.cargo||'-'}</td>
        <td>${r.epp}</td>
        <td>${r.responsable}</td>
        <td>${r.foto ? `<button onclick="verFoto('${r.id}','epp')" style="background:none;border:none;color:var(--gold-light);cursor:pointer;font-size:0.85rem;">üì∑ Ver</button>` : '-'}</td>
        <td><button onclick="eliminarEPP('${r.id}')" class="btn-sm btn-red" style="font-size:0.75rem;">üóë</button></td>
      </tr>`;

    cards.innerHTML += `
      <div class="m-card">
        <div class="m-card-top">
          <span class="m-card-id">${r.nombre}</span>
          <span class="badge badge-gold">${r.area}</span>
        </div>
        <div class="m-row"><strong>Fecha:</strong> ${r.fecha}</div>
        <div class="m-row"><strong>Cargo:</strong> ${r.cargo||'-'}</div>
        <div class="m-row"><strong>EPP:</strong> ${r.epp}</div>
        <div class="m-row" style="margin-bottom:0.5rem;"><strong>Responsable:</strong> ${r.responsable}</div>
        ${r.foto ? `<div style="margin-bottom:0.5rem;"><button onclick="verFoto('${r.id}','epp')" style="background:none;border:1px solid var(--border);color:var(--gold-light);cursor:pointer;font-size:0.82rem;padding:0.3rem 0.7rem;border-radius:5px;width:100%;">üì∑ Ver foto</button></div>` : ''}
        <button onclick="eliminarEPP('${r.id}')" class="btn-sm btn-red" style="width:100%;padding:0.5rem;">üóë Eliminar</button>
      </div>`;
  });
}

/* ‚îÄ‚îÄ ENVIAR TICKET (CONDUCTOR) ‚îÄ‚îÄ */
window.enviarTicket = async () => {
  const placa   = document.getElementById('c-placa').value.trim();
  const nombre  = document.getElementById('c-nombre').value.trim();
  const novedad = document.getElementById('c-novedad').value.trim();

  if (!placa)   { toast('Ingresa la placa del veh√≠culo', 'err'); return; }
  if (!nombre)  { toast('Ingresa el nombre del conductor', 'err'); return; }
  if (!novedad) { toast('Describe la novedad', 'err'); return; }

  const btn = document.getElementById('c-btn-enviar');
  btn.disabled = true; btn.textContent = 'Enviando...'; showLoader();

  try {
    await addDoc(colTickets, {
      placa, nombre, novedad,
      estado: 'abierto',
      observaciones: '',
      foto: fotoData.c || null,
      fechaCreacion: Timestamp.now(),
      fechaCierre: null
    });
    document.getElementById('c-placa').value   = '';
    document.getElementById('c-nombre').value  = '';
    document.getElementById('c-novedad').value = '';
    document.getElementById('c-count').textContent = '0 / 500';
    clearFoto('c');
    toast('‚úÖ Ticket enviado correctamente', 'ok');
  } catch(err) {
    if (!navigator.onLine) toast('Sin conexi√≥n ‚Äî se enviar√° cuando vuelva la se√±al', 'inf');
    else toast('Error al enviar: ' + err.message, 'err');
  } finally {
    btn.disabled = false; btn.textContent = 'Enviar Ticket'; hideLoader();
  }
};

/* ‚îÄ‚îÄ ENVIAR EPP ‚îÄ‚îÄ */
window.enviarEPP = async () => {
  const nombre      = document.getElementById('ep-nombre').value.trim();
  const cargo       = document.getElementById('ep-cargo').value;
  const epp         = document.getElementById('ep-epp').value;
  const responsable = document.getElementById('ep-responsable').value;
  const fecha       = document.getElementById('ep-fecha').value;

  if (!nombre)      { toast('Ingresa el nombre del colaborador', 'err'); return; }
  if (!cargo)       { toast('Selecciona el cargo', 'err'); return; }
  if (!epp)         { toast('Selecciona el EPP', 'err'); return; }
  if (!responsable) { toast('Selecciona el responsable', 'err'); return; }

  const btn = document.getElementById('ep-btn-enviar');
  btn.disabled = true; btn.textContent = 'Guardando...'; showLoader();

  try {
    await addDoc(colEPP, {
      area: subTab.toUpperCase(),
      nombre, cargo, epp, responsable, fecha,
      foto: fotoData.ep || null,
      fechaCreacion: Timestamp.now()
    });
    document.getElementById('ep-nombre').value = '';
    document.getElementById('ep-cargo').value  = '';
    document.getElementById('ep-epp').value    = '';
    document.getElementById('ep-responsable').value = '';
    document.getElementById('ep-fecha').value  = fechaHoy();
    clearFoto('ep');
    toast('‚úÖ Registro EPP guardado', 'ok');
  } catch(err) {
    if (!navigator.onLine) toast('Sin conexi√≥n ‚Äî se guardar√° cuando vuelva la se√±al', 'inf');
    else toast('Error al registrar: ' + err.message, 'err');
  } finally {
    btn.disabled = false; btn.textContent = 'Registrar Entrega EPP'; hideLoader();
  }
};

/* ‚îÄ‚îÄ ACCIONES TICKETS ‚îÄ‚îÄ */
window.guardarObs = async (id, obs) => {
  try {
    await updateDoc(doc(db, 'tickets', id), { observaciones: obs });
    toast('Observaci√≥n guardada', 'ok');
  } catch { toast('Error al guardar observaci√≥n', 'err'); }
};

window.cerrarTicket = async (id) => {
  try {
    await updateDoc(doc(db, 'tickets', id), { estado: 'cerrado', fechaCierre: Timestamp.now() });
    toast('Ticket cerrado ‚úì', 'ok');
  } catch { toast('Error al cerrar ticket', 'err'); }
};

window.eliminarTicket = async (id) => {
  if (!confirm('¬øEliminar este ticket permanentemente?')) return;
  try {
    await deleteDoc(doc(db, 'tickets', id));
    toast('Ticket eliminado', 'ok');
  } catch { toast('Error al eliminar', 'err'); }
};

window.eliminarEPP = async (id) => {
  if (!confirm('¬øEliminar este registro EPP?')) return;
  try {
    await deleteDoc(doc(db, 'epp_registros', id));
    toast('Registro eliminado', 'ok');
  } catch { toast('Error al eliminar', 'err'); }
};

/* ‚îÄ‚îÄ VER FOTO ‚îÄ‚îÄ */
window.verFoto = async (id, tipo) => {
  showLoader();
  try {
    const colRef = tipo === 'ticket' ? colTickets : colEPP;
    const nombre = tipo === 'ticket' ? 'tickets' : 'epp_registros';
    const snap   = await getDoc(doc(db, nombre, id));
    const foto   = snap.exists() ? snap.data().foto : null;
    if (!foto) { toast('Sin foto disponible', 'err'); return; }
    const m = document.createElement('div');
    m.className = 'modal'; m.onclick = () => m.remove();
    m.innerHTML = `<img src="${foto}" alt="Evidencia">`;
    document.body.appendChild(m);
  } catch { toast('Error al cargar foto', 'err'); }
  finally { hideLoader(); }
};

/* ‚îÄ‚îÄ EXPORTAR EXCEL ‚îÄ‚îÄ */
window.exportarFlota = async () => {
  showLoader();
  try {
    const snap = await getDocs(query(colTickets, orderBy('fechaCreacion', 'desc')));
    if (snap.empty) { toast('No hay tickets para exportar', 'err'); return; }
    const data = [];
    snap.forEach(d => {
      const t = d.data();
      data.push({
        'Creaci√≥n': fmt(t.fechaCreacion), 'Cierre': fmt(t.fechaCierre),
        'Tiempo': tiempoTranscurrido(t.fechaCreacion, t.fechaCierre),
        'Placa': t.placa, 'Conductor': t.nombre, 'Novedad': t.novedad,
        'Observaciones': t.observaciones||'',
        'Estado': t.estado?.toUpperCase(), 'Foto': t.foto ? 'S√ç':'NO'
      });
    });
    const ws = XLSX.utils.json_to_sheet(data);
    ws['!cols'] = [{wch:18},{wch:18},{wch:10},{wch:10},{wch:22},{wch:40},{wch:35},{wch:10},{wch:5}];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Tickets Flota');
    XLSX.writeFile(wb, `flota_tickets_${fechaHoy()}.xlsx`);
    toast('Excel descargado ‚úì', 'ok');
  } catch(err) { toast('Error al exportar: ' + err.message, 'err'); }
  finally { hideLoader(); }
};

window.exportarSeguridad = async () => {
  showLoader();
  try {
    const snap = await getDocs(query(colEPP, orderBy('fechaCreacion', 'desc')));
    if (snap.empty) { toast('No hay registros EPP', 'err'); return; }
    const data = [];
    snap.forEach(d => {
      const r = d.data();
      data.push({
        'Fecha': r.fecha, '√Årea': r.area, 'Colaborador': r.nombre,
        'Cargo': r.cargo||'', 'EPP': r.epp, 'Responsable': r.responsable,
        'Foto': r.foto ? 'S√ç':'NO', 'Registro': fmt(r.fechaCreacion)
      });
    });
    const ws = XLSX.utils.json_to_sheet(data);
    ws['!cols'] = [{wch:12},{wch:6},{wch:25},{wch:20},{wch:25},{wch:22},{wch:5},{wch:18}];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'EPP');
    XLSX.writeFile(wb, `seguridad_epp_${fechaHoy()}.xlsx`);
    toast('Excel descargado ‚úì', 'ok');
  } catch(err) { toast('Error al exportar: ' + err.message, 'err'); }
  finally { hideLoader(); }
};
</script>
</body>
</html>