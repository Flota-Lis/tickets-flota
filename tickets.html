<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Tickets - Conductores</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
</head>
<body class="bg-gradient-to-br from-blue-50 to-indigo-100 min-h-screen">
    <div id="app" class="container mx-auto px-4 py-8 max-w-6xl">
        <!-- Header -->
        <div class="bg-white rounded-lg shadow-lg p-6 mb-6">
            <div class="flex justify-between items-center">
                <h1 class="text-3xl font-bold text-indigo-900">Sistema de Tickets</h1>
                <div class="flex gap-2">
                    <button onclick="mostrarVista('conductor')" 
                            class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        üë®‚Äç‚úàÔ∏è Conductor
                    </button>
                    <button onclick="mostrarVista('admin')" 
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition">
                        üîê Admin
                    </button>
                </div>
            </div>
        </div>

        <!-- Vista Conductor -->
        <div id="vistaConductor" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-8">
                <h2 class="text-2xl font-bold text-gray-800 mb-6">üìù Reportar Novedad</h2>
                
                <form id="formTicket" class="space-y-4">
                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Placa del Veh√≠culo *</label>
                        <input type="text" id="placa" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent uppercase"
                               placeholder="ABC123">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Nombre del Conductor *</label>
                        <input type="text" id="nombre" required
                               class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                               placeholder="Nombre completo">
                    </div>

                    <div>
                        <label class="block text-sm font-semibold text-gray-700 mb-2">Novedad / Problema *</label>
                        <textarea id="novedad" required rows="4"
                                  class="w-full px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent"
                                  placeholder="Describe la novedad o problema..."></textarea>
                    </div>

                    <button type="submit" 
                            class="w-full bg-indigo-600 text-white py-4 rounded-lg font-bold text-lg hover:bg-indigo-700 transition shadow-lg">
                        ‚úâÔ∏è Enviar Ticket
                    </button>
                </form>

                <div id="mensajeExito" class="hidden mt-4 p-4 bg-green-100 border border-green-400 text-green-700 rounded-lg">
                    ‚úÖ Ticket enviado exitosamente. El administrador ser√° notificado.
                </div>
            </div>
        </div>

        <!-- Vista Admin -->
        <div id="vistaAdmin" class="hidden">
            <div class="bg-white rounded-lg shadow-lg p-6">
                <div class="flex justify-between items-center mb-6">
                    <h2 class="text-2xl font-bold text-gray-800">üé´ Panel de Administraci√≥n</h2>
                    <div class="flex gap-2">
                        <button onclick="exportarExcel()" 
                                class="px-4 py-2 bg-emerald-600 text-white rounded-lg hover:bg-emerald-700 transition">
                            üìä Exportar Excel
                        </button>
                        <button onclick="borrarTodos()" 
                                class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition">
                            üóëÔ∏è Borrar Todo
                        </button>
                    </div>
                </div>

                <!-- Notificaciones -->
                <div id="notificaciones" class="mb-4"></div>

                <!-- Filtros -->
                <div class="mb-4 flex gap-2">
                    <button onclick="filtrarTickets('todos')" 
                            class="px-4 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700 transition filter-btn">
                        Todos (<span id="countTodos">0</span>)
                    </button>
                    <button onclick="filtrarTickets('abierto')" 
                            class="px-4 py-2 bg-yellow-600 text-white rounded-lg hover:bg-yellow-700 transition filter-btn">
                        Abiertos (<span id="countAbiertos">0</span>)
                    </button>
                    <button onclick="filtrarTickets('cerrado')" 
                            class="px-4 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700 transition filter-btn">
                        Cerrados (<span id="countCerrados">0</span>)
                    </button>
                </div>

                <!-- Lista de Tickets -->
                <div id="listaTickets" class="space-y-3 max-h-[600px] overflow-y-auto">
                    <!-- Los tickets se cargar√°n aqu√≠ -->
                </div>

                <div id="sinTickets" class="hidden text-center py-12 text-gray-500">
                    <div class="text-6xl mb-4">üìã</div>
                    <p class="text-xl">No hay tickets registrados</p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Estado de la aplicaci√≥n
        let tickets = [];
        let filtroActual = 'todos';
        let notificacionesPendientes = 0;

        // Cargar datos al iniciar
        async function cargarDatos() {
            try {
                const result = await window.storage.get('tickets');
                if (result && result.value) {
                    tickets = JSON.parse(result.value);
                    actualizarContadores();
                    renderizarTickets();
                }
            } catch (error) {
                console.log('No hay tickets previos');
            }

            // Cargar notificaciones pendientes
            try {
                const notifResult = await window.storage.get('notificaciones_pendientes');
                if (notifResult && notifResult.value) {
                    notificacionesPendientes = parseInt(notifResult.value);
                }
            } catch (error) {
                console.log('No hay notificaciones previas');
            }
        }

        // Guardar datos
        async function guardarDatos() {
            await window.storage.set('tickets', JSON.stringify(tickets));
            actualizarContadores();
        }

        // Inicializar aplicaci√≥n
        window.addEventListener('load', async () => {
            await cargarDatos();
            mostrarVista('conductor');
        });

        // Mostrar vista
        function mostrarVista(vista) {
            document.getElementById('vistaConductor').classList.add('hidden');
            document.getElementById('vistaAdmin').classList.add('hidden');
            
            if (vista === 'conductor') {
                document.getElementById('vistaConductor').classList.remove('hidden');
            } else {
                document.getElementById('vistaAdmin').classList.remove('hidden');
                renderizarTickets();
                mostrarNotificaciones();
            }
        }

        // Formulario de ticket
        document.getElementById('formTicket').addEventListener('submit', async (e) => {
            e.preventDefault();
            
            const ticket = {
                id: Date.now(),
                fecha: new Date().toLocaleString('es-CO', {
                    year: 'numeric',
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                }),
                placa: document.getElementById('placa').value.toUpperCase(),
                nombre: document.getElementById('nombre').value,
                novedad: document.getElementById('novedad').value,
                estado: 'abierto'
            };

            tickets.unshift(ticket);
            await guardarDatos();
            
            // Incrementar notificaciones
            notificacionesPendientes++;
            await window.storage.set('notificaciones_pendientes', notificacionesPendientes.toString());

            // Limpiar formulario
            document.getElementById('formTicket').reset();
            
            // Mostrar mensaje de √©xito
            const mensaje = document.getElementById('mensajeExito');
            mensaje.classList.remove('hidden');
            setTimeout(() => {
                mensaje.classList.add('hidden');
            }, 5000);
        });

        // Mostrar notificaciones
        function mostrarNotificaciones() {
            const notifDiv = document.getElementById('notificaciones');
            
            if (notificacionesPendientes > 0) {
                notifDiv.innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-4 flex justify-between items-center">
                        <div>
                            <p class="font-bold">üîî ${notificacionesPendientes} nuevo${notificacionesPendientes > 1 ? 's' : ''} ticket${notificacionesPendientes > 1 ? 's' : ''} sin revisar</p>
                        </div>
                        <button onclick="limpiarNotificaciones()" 
                                class="px-3 py-1 bg-red-600 text-white rounded hover:bg-red-700">
                            Marcar como visto
                        </button>
                    </div>
                `;
            } else {
                notifDiv.innerHTML = '';
            }
        }

        // Limpiar notificaciones
        async function limpiarNotificaciones() {
            notificacionesPendientes = 0;
            await window.storage.set('notificaciones_pendientes', '0');
            mostrarNotificaciones();
        }

        // Actualizar contadores
        function actualizarContadores() {
            const abiertos = tickets.filter(t => t.estado === 'abierto').length;
            const cerrados = tickets.filter(t => t.estado === 'cerrado').length;
            
            document.getElementById('countTodos').textContent = tickets.length;
            document.getElementById('countAbiertos').textContent = abiertos;
            document.getElementById('countCerrados').textContent = cerrados;
        }

        // Filtrar tickets
        function filtrarTickets(filtro) {
            filtroActual = filtro;
            renderizarTickets();
        }

        // Renderizar tickets
        function renderizarTickets() {
            const lista = document.getElementById('listaTickets');
            const sinTickets = document.getElementById('sinTickets');
            
            let ticketsFiltrados = tickets;
            if (filtroActual !== 'todos') {
                ticketsFiltrados = tickets.filter(t => t.estado === filtroActual);
            }

            if (ticketsFiltrados.length === 0) {
                lista.innerHTML = '';
                sinTickets.classList.remove('hidden');
                return;
            }

            sinTickets.classList.add('hidden');
            
            lista.innerHTML = ticketsFiltrados.map(ticket => `
                <div class="border rounded-lg p-4 ${ticket.estado === 'abierto' ? 'bg-yellow-50 border-yellow-300' : 'bg-green-50 border-green-300'}">
                    <div class="flex justify-between items-start">
                        <div class="flex-1">
                            <div class="flex items-center gap-2 mb-2">
                                <span class="px-3 py-1 rounded-full text-xs font-bold ${
                                    ticket.estado === 'abierto' 
                                    ? 'bg-yellow-200 text-yellow-800' 
                                    : 'bg-green-200 text-green-800'
                                }">
                                    ${ticket.estado.toUpperCase()}
                                </span>
                                <span class="text-sm text-gray-600">üìÖ ${ticket.fecha}</span>
                            </div>
                            
                            <div class="grid grid-cols-2 gap-3 mb-3">
                                <div>
                                    <span class="text-xs font-semibold text-gray-600">Placa:</span>
                                    <p class="text-lg font-bold text-indigo-900">${ticket.placa}</p>
                                </div>
                                <div>
                                    <span class="text-xs font-semibold text-gray-600">Conductor:</span>
                                    <p class="text-lg font-bold text-gray-800">${ticket.nombre}</p>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <span class="text-xs font-semibold text-gray-600">Novedad:</span>
                                <p class="text-gray-700 mt-1">${ticket.novedad}</p>
                            </div>
                        </div>
                        
                        <div class="flex flex-col gap-2 ml-4">
                            <button onclick="cambiarEstado(${ticket.id})" 
                                    class="px-4 py-2 ${
                                        ticket.estado === 'abierto' 
                                        ? 'bg-green-600 hover:bg-green-700' 
                                        : 'bg-yellow-600 hover:bg-yellow-700'
                                    } text-white rounded-lg text-sm font-semibold transition">
                                ${ticket.estado === 'abierto' ? '‚úì Cerrar' : '‚Ü∫ Reabrir'}
                            </button>
                            <button onclick="eliminarTicket(${ticket.id})" 
                                    class="px-4 py-2 bg-red-600 hover:bg-red-700 text-white rounded-lg text-sm font-semibold transition">
                                üóëÔ∏è Eliminar
                            </button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Cambiar estado del ticket
        async function cambiarEstado(id) {
            const ticket = tickets.find(t => t.id === id);
            if (ticket) {
                ticket.estado = ticket.estado === 'abierto' ? 'cerrado' : 'abierto';
                await guardarDatos();
                renderizarTickets();
            }
        }

        // Eliminar ticket
        async function eliminarTicket(id) {
            if (confirm('¬øEst√°s seguro de eliminar este ticket?')) {
                tickets = tickets.filter(t => t.id !== id);
                await guardarDatos();
                renderizarTickets();
            }
        }

        // Borrar todos los tickets
        async function borrarTodos() {
            if (confirm('¬øEst√°s seguro de eliminar TODOS los tickets? Esta acci√≥n no se puede deshacer.')) {
                tickets = [];
                notificacionesPendientes = 0;
                await guardarDatos();
                await window.storage.set('notificaciones_pendientes', '0');
                renderizarTickets();
                mostrarNotificaciones();
            }
        }

        // Exportar a Excel
        function exportarExcel() {
            if (tickets.length === 0) {
                alert('No hay tickets para exportar');
                return;
            }

            // Preparar datos para Excel
            const datosExcel = tickets.map(ticket => ({
                'Fecha': ticket.fecha,
                'Placa': ticket.placa,
                'Conductor': ticket.nombre,
                'Novedad': ticket.novedad,
                'Estado': ticket.estado.toUpperCase()
            }));

            // Crear workbook
            const ws = XLSX.utils.json_to_sheet(datosExcel);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "Tickets");

            // Ajustar ancho de columnas
            const maxWidth = 50;
            const wscols = [
                { wch: 18 }, // Fecha
                { wch: 10 }, // Placa
                { wch: 25 }, // Conductor
                { wch: maxWidth }, // Novedad
                { wch: 10 }  // Estado
            ];
            ws['!cols'] = wscols;

            // Descargar archivo
            const fecha = new Date().toLocaleDateString('es-CO').replace(/\//g, '-');
            XLSX.writeFile(wb, `tickets_conductores_${fecha}.xlsx`);
        }
    </script>
</body>
</html>